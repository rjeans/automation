---
# Certificate for TLS
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: cluster-dashboard-tls
  namespace: cluster-dashboard
  labels:
    app.kubernetes.io/name: cluster-dashboard
spec:
  secretName: cluster-dashboard-tls
  issuerRef:
    name: letsencrypt-production
    kind: ClusterIssuer
  dnsNames:
    - dashboard.automation.local  # Change this to your actual domain
  # For testing with self-signed cert, use:
  # issuerRef:
  #   name: selfsigned-issuer
  #   kind: ClusterIssuer

---
# Ingress for external access via Traefik
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cluster-dashboard
  namespace: cluster-dashboard
  labels:
    app.kubernetes.io/name: cluster-dashboard
  annotations:
    # Traefik specific annotations
    traefik.ingress.kubernetes.io/router.priority: "10"
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"

    # Security headers
    traefik.ingress.kubernetes.io/router.middlewares: cluster-dashboard-security@kubernetescrd

    # Rate limiting (optional - prevents abuse)
    # traefik.ingress.kubernetes.io/router.middlewares: cluster-dashboard-ratelimit@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
    - secretName: cluster-dashboard-tls
      hosts:
        - dashboard.automation.local  # Change this to your actual domain
  rules:
    - host: dashboard.automation.local  # Change this to your actual domain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: cluster-dashboard
                port:
                  name: http

---
# Middleware for security headers
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security
  namespace: cluster-dashboard
spec:
  headers:
    frameDeny: true
    browserXssFilter: true
    contentTypeNosniff: true
    stsSeconds: 31536000
    stsIncludeSubdomains: true
    stsPreload: true
    customResponseHeaders:
      X-Robots-Tag: "noindex, nofollow"  # Prevent search engine indexing

---
# Optional: Rate limiting middleware to prevent abuse
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: ratelimit
  namespace: cluster-dashboard
spec:
  rateLimit:
    average: 100
    period: 1m
    burst: 50
